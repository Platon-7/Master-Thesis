Bootstrap: docker
From: nvidia/cuda:12.4.1-cudnn-devel-ubuntu22.04

%labels
    Author P.Karageorgis
    Version 4.0 (The "Author's YAML" Edition)

%environment
    export PATH="/opt/conda/bin:$PATH"
    export MUJOCO_GL="glfw"
    export LD_LIBRARY_PATH="/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH"

%post
    # --- 1. SYSTEM DEPENDENCIES ---
    apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
        wget git gcc g++ make cmake vim \
        xvfb \
        libgl1-mesa-dev \
        libgl1-mesa-glx \
        libglew-dev \
        libosmesa6-dev \
        libglfw3 \
        libglfw3-dev \
        patchelf \
        python3 python3-pip \
        ffmpeg \
        unzip

    # --- 2. INSTALL MINIFORGE ---
    wget https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-x86_64.sh -O miniforge.sh
    bash miniforge.sh -b -p /opt/conda
    rm miniforge.sh
    export PATH="/opt/conda/bin:$PATH"

    # --- 3. CREATE ENVIRONMENTS ---

    # ==============================================
    # ENV 1: QWEN HOST (Qwen 3 8B Support)
    # ==============================================
    conda create -n qwen_host python=3.10 -y
    . /opt/conda/etc/profile.d/conda.sh
    conda activate qwen_host
    
    # Core Inference Stack
    # REMOVED "flash-attn" to prevent build failure on Titan RTX (Turing)
    pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121
    pip install "transformers>=4.40" "accelerate>=0.26" "bitsandbytes" "qwen-vl-utils" 
    pip install "uvicorn" "fastapi" "pydantic" "requests"

    # ==============================================
    # ENV 2: RL VLMF (Strict Author Compliance)
    # ==============================================
    conda create -n rlvlmf python=3.9 -y
    conda activate rlvlmf

    # A. Build Tools
    pip install setuptools==69.5.1 wheel
    pip install cmake==3.26.4 pybind11==2.10.4 pybind11-global==2.10.4

    # B. The "Hydra 0.11" Fix
    # Installing dependencies first ensures the git install goes smoothly
    pip install "omegaconf<2.0" "antlr4-python3-runtime==4.8"
    pip install git+https://github.com/facebookresearch/hydra@0.11_branch

    # C. Core Deps
    # numpy<2 is critical for Gym
    pip install "cython<3" "numpy<2"
    pip install absl-py pyparsing chardet termcolor scikit-image tqdm shapely ftfy regex pyquaternion pygame pandas==2.1.4 glfw==1.11.2

    # D. RL & Physics
    # Note: Installing mujoco-py explicitly helps prevent build errors if Metaworld needs it
    pip install gym==0.25.2 gymnasium==0.29.1 
    pip install pyopengl==3.1.7 mujoco==3.1.1
    
    # E. Vision & AI
    pip install openai==1.3.5 google-generativeai salesforce-lavis
    pip install git+https://github.com/openai/CLIP.git

    # F. Visualization & Logging
    pip install tensorboard matplotlib
    pip install "moviepy<2.0" "imageio<3.0" imageio-ffmpeg "Pillow<10.0.0"

    # G. Metaworld (Time Travel Fix)
    # We clone into /tmp to keep the image clean
    cd /tmp
    rm -rf Metaworld
    git clone https://github.com/Farama-Foundation/Metaworld.git
    cd Metaworld
    git checkout $(git rev-list -n 1 --before="2023-06-01" master)
    pip install .
    cd /